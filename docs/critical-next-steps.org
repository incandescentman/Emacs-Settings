#+TITLE: Critical Next Steps & Simplification Roadmap
#+DATE: 2025-11-26
#+DESCRIPTION: Technical debt, improvements, simplification plan, and future roadmap

* Overview

This document tracks:
- Active technical debt that should be addressed
- Planned improvements and why they matter
- Simplification opportunities with implementation details
- Stretch goals for future consideration
- Things explicitly NOT being pursued (and why)

Status indicators:
- *[ACTIVE]* - Currently important, should address soon
- *[PLANNED]* - Scoped and ready to implement
- *[COMPLETED]* - Done
- *[OPTIONAL]* - Would be nice, but not critical
- *[TABLED]* - Decided not to pursue (for now)

*Progress:* 2 of 9 major simplifications completed (22%)

* Completed Simplifications

** [COMPLETED] 2025-10-26: Removed init-working.el backup
- Deleted =spacemacs.d/init-working.el= (old backup from Oct 14)
- Active config (=/Users/jay/emacs/emacs-settings/spacemacs.d/init.el=) is newer with better features
- Eliminated confusion between two similar files
- *Savings:* 1 redundant file removed

** [COMPLETED] 2025-10-26: Converted pasteboard to pure elisp
- Removed =pasteboard-copy-and-paste-functions.org=
- Source of truth is now =pasteboard-copy-and-paste-functions.el= (pure elisp)
- Added rich Commentary section with usage examples
- Removed auto-tangling overhead
- *Savings:* No more edit-tangle-test cycle, direct edit-test workflow

* High Priority (Active)

** [ACTIVE] Harden Pasteboard Regression Tests

*Why it matters*:
- Sanitizer regressions have bitten us multiple times (tables, emoji, headings)
- Manual testing is time-consuming and error-prone
- Don't catch issues until they hit production use

*Current state*:
- No automated tests
- Rely on manual smoke tests
- Regressions escape easily

*Proposal*:
1. Create =test-fixtures/= directory with sample inputs:
   - =markdown-with-tables.txt=
   - =emoji-compound.txt=
   - =mixed-markdown-org.txt=
   - =github-flavored-markdown.txt=
   - =chatgpt-output.txt=

2. Write batch Emacs script that:
   - Loads pasteboard functions
   - Runs =pasteboard--clean-string= on each fixture
   - Compares output to expected result
   - Reports differences

3. Add to git pre-commit hook or CI

*Example test*:
#+BEGIN_SRC emacs-lisp
;; test-pasteboard.el
(require 'ert)
(load-file "pasteboard-copy-and-paste-functions.el")

(ert-deftest test-markdown-table-separators ()
  "Table separators should be preserved"
  (let ((input "| Col1 | Col2 |\n|------|------|\n| A    | B    |")
        (expected "| Col1 | Col2 |\n|------|------|\n| A    | B    |"))
    (should (string= (pasteboard--clean-string input) expected))))
#+END_SRC

*Next steps*:
1. Collect problematic inputs from past bugs (see =codebase-wisdom.org=)
2. Create expected outputs
3. Write test harness
4. Run before each release

*Effort*: ~4-6 hours initial setup, ~30 minutes per new test

** [ACTIVE] Eliminate the Dual Boot Path

*Why it matters*:
Two complete startup systems create massive duplication:
- Spacemacs: =/Users/jay/emacs/emacs-settings/spacemacs.d/init.el= (1,255 lines) - ACTIVE
- GNU Emacs: =gnu-emacs-startup.el= (1,342 lines) - UNUSED

Settings must be synchronized across both, leading to drift and maintenance burden.

*Recommendation*:
1. Choose Spacemacs (currently active)
2. Delete =gnu-emacs-startup.el= and =gnu-emacs-startup.org=
3. Archive to git history if needed later

*Savings:* ~1,400 lines, eliminates dual-maintenance burden

*Implementation*:
#+begin_src bash
# Commit current state first
git add gnu-emacs-startup.{el,org}
git commit -m "Archive: GNU Emacs standalone config (moving to Spacemacs-only)"

# Remove files
rm gnu-emacs-startup.{el,org}
#+end_src

** [ACTIVE] Remove Commented/Dead Code

*Why it matters*:
Docs note "large blocks of commented-out code" throughout config.

*Examples found*:
- =spacemacs-new-config.el:23-36= (debugging code)
- Commented =use-package= blocks throughout
- Disabled layers in init files

*Implementation*:
#+begin_src bash
# Find commented use-package blocks
grep -n "^;; (use-package\|^;;  (load" *.el

# Find large commented blocks (10+ consecutive lines)
awk '/^;;/{n++} !/^;;/{if(n>10) print FILENAME":"NR-n"-"NR; n=0}' *.el

# After review, delete entire commented blocks
#+end_src

*Savings:* ~300-500 lines, improved readability

* Medium Priority (Planned)

** [COMPLETED] Create "Known Good" Recovery System

*Status*: Documented in =recovery-guide.org=

Simple manual approach using git tags + worktrees:
1. Tag working state: =git tag -f known-good HEAD=
2. Create worktree: =git worktree add ~/emacs/emacs-settings-known-good known-good=
3. When broken, launch with: =SPACEMACSDIR=~/emacs/emacs-settings-known-good/spacemacs.d emacs=

No automation needed - just manual git commands when things break.

** [PLANNED] Document Function Dependencies

*Why it matters*:
- Some functions depend on others being loaded first
- Loading order bugs are hard to debug
- Dependencies are implicit (no documentation)

*Current problem*:
- =key-minor-mode-map= must load before functions that use it
- =shared-functions.el= must load before modules that call its functions

*Proposal*:
Add dependency comments at top of each major file:

#+BEGIN_SRC emacs-lisp
;;; pasteboard-copy-and-paste-functions.el --- Clipboard integration
;;
;; Dependencies:
;;   - shared-functions.el (required)
;;   - jay-osx.el (optional, for key-minor-mode-map)
;;   - External: pbcopy, pbpaste (macOS command-line tools)
;;
;; Must load AFTER: shared-functions.el
;; Must load BEFORE: (none)
#+END_SRC

*Effort*: ~2-3 hours

** [PLANNED] Add Deprecation Tracking

*Why it matters*:
- Emacs and Org-mode deprecate functions regularly
- Warnings accumulate, eventually things break

*Proposal*:
1. Create =docs/deprecations.org= to track warnings
2. Run =emacs --batch --eval "(byte-compile-file \"file.el\")"= to find warnings
3. Fix high-priority before each major Emacs/Spacemacs upgrade

*Effort*: ~3-4 hours initial, ~1 hour per major update

** [PLANNED] Unify Keybinding Configuration

*Why it matters*:
Keybindings scattered across:
- =keys.el= (376 lines)
- =jay-osx.el= (defines =key-minor-mode-map=)
- =gnu-emacs-startup.el= (global-set-key calls)
- =shared-functions.org= (* Keybindings section)

*Recommendation:* Consolidate into =keys.el= only, organized by feature:
#+begin_src emacs-lisp
;;; keys.el --- All keybindings in one place -*- lexical-binding: t -*-

;; === Window Management ===
(global-set-key (kbd "s-1") 'delete-other-windows)

;; === Org Mode ===
(with-eval-after-load 'org
  (define-key org-mode-map (kbd "M-RET") 'org-meta-return))

(provide 'keys)
#+end_src

*Benefits:* Single source of truth for all keybindings

** [PLANNED] Consolidate Org-Mode Settings

*Why it matters*:
Org settings spread across:
- =/Users/jay/emacs/emacs-settings/spacemacs.d/init.el= (performance settings)
- =shared-functions.org= (org-mode settings)
- =org-roam-config.el=
- =org-visual-style.el=
- =org-yt.el=

*Recommendation:* Create unified =org-config.el= that loads all org modules.

** [PLANNED] Fix Structural Issues

*Problems identified*:
- Missing =lexical-binding= declarations
- Deprecated functions (=org-bracket-link-regexp= → =org-link-bracket-re=)
- Inconsistent quote styles
- Mixed indentation

*Implementation*:
#+begin_src bash
# 1. Find files missing lexical-binding
grep -L "lexical-binding: t" ~/emacs/emacs-settings/*.el

# 2. Add to each file (must be first line):
# -*- lexical-binding: t -*-

# 3. Find deprecated org variables
grep -r "org-bracket-link-regexp" ~/emacs/emacs-settings/
#+end_src

* Optional Improvements

** [OPTIONAL] Profile Startup Time

*Current*: Startup is ~5-8 seconds (acceptable but could be better)

*Proposal*:
#+BEGIN_SRC sh
emacs --debug-init --timed-requires
#+END_SRC

Identify top 5 slowest items, estimate potential gains, decide if worth optimizing.

*Status*: Startup is acceptable, optimization is premature

** [OPTIONAL] Convert Remaining Literate Org Files to Pure Elisp

*Current state*: 3 auto-tangling org files remain:
- =shared-functions.org= (324KB) - Keep as literate (too large/complex)
- =spacecraft-mode.org= (40KB) - Candidate for conversion
- =fonts-and-themes.org= (13KB) - Candidate for conversion

*Benefits*: Eliminates tangling errors, faster edit-test cycle

** [OPTIONAL] Use Package Manager Instead of Vendored Code

*Problem:* Large vendored files clutter the config:
- =dired+.el= (868KB)
- =highlight-tail.el= (48KB)
- =poetry_JD.el=, =forecast.el=, =ox-koma-letter.el=

*Recommendation*: Check MELPA availability or move to =vendor/= subdirectory.

** [OPTIONAL] Optimize Loading with use-package

*Problem:* Many packages loaded eagerly in =dotspacemacs-additional-packages=.

*Improved approach*:
#+begin_src emacs-lisp
(use-package org-transclusion
  :defer t
  :after org
  :commands org-transclusion-mode)
#+end_src

*Benefit:* Faster startup time

* Stretch Goals (Future)

** [IDEA] Package Critical Helpers as Reusable Modules

*What to package*:
- Pasteboard integration (as =pasteboard-mode=)
- Smart capitalization functions
- Org-roam profile switching (as =org-roam-profiles=)

*Effort:* Significant (~10-20 hours per package)

** [IDEA] Automated Linting

*Tools to consider*:
- =checkdoc= - Documentation string checker
- =package-lint= - Package metadata checker
- =elisp-lint= - General linting
- =relint= - Regexp linter

*Effort:* ~6-8 hours setup, ongoing maintenance

* Explicitly NOT Pursuing

** Multi-Platform Support
*Why not*: Primary platform is macOS. Pasteboard functions are macOS-specific. Cross-platform would dilute integration depth. Better to optimize for one platform.

** IDE-Like Features
*Why not*: This is a writing environment, not a development IDE. Focus is org-mode and writing.

** Org-Mode Alternatives
*Why not*: Deeply invested in org-mode. 10+ years of org-roam notes. Org-mode is the canonical format.

** Perfect Consistency
*Why not*: "Perfect is the enemy of good." Refactoring for aesthetics = busywork. Incremental improvement is fine.

*Philosophy*: Pragmatism over purity.

* Progress Tracking

| Change                         | Lines Saved  | Complexity Reduction | Status      |
|--------------------------------+--------------+----------------------+-------------|
| Remove init-working.el backup  | 1 file       | *                    | DONE        |
| Convert pasteboard to pure .el | Workflow     | ***                  | DONE        |
| Remove GNU Emacs dual boot     | ~1,400       | *****                | Pending     |
| Consolidate config loads       | ~200         | ***                  | Pending     |
| Remove commented code          | ~300-500     | ****                 | Pending     |
| Fix deprecated functions       | ~50          | ** (stability++)     | Pending     |
| Unify keybindings              | ~100         | ****                 | Pending     |
| Defer package loading          | ~0           | **                   | Pending     |
| Consolidate org settings       | ~150         | ****                 | Pending     |
|--------------------------------+--------------+----------------------+-------------|
| *TOTAL*                        | *~2,200*     | *Much easier*        | 2/9 done    |

* Decision Log

** 2025-12-31: Major documentation consolidation
*Reason*: Reduced docs/ from 14+ files to 11. Merged redundant files, extracted key lessons to codebase-wisdom.org, deleted obsolete incident logs.

** 2025-11-26: Merged documentation files
*Reason*: =critical-next-steps.org= and =suggested-next-steps.org= were redundant. Combined into single roadmap document.

** 2025-11-26: Completed Major Documentation Overhaul
*Reason*: Significant rewrite of core documentation files to improve clarity.

** 2025-10-26: Tabled "Document Hydras"
*Reason*: Solo user, hydras are discoverable enough, low ROI

** 2025-10-26: Prioritized Regression Tests
*Reason*: Clipboard bugs have cost hours of debugging multiple times

** 2025-10-26: Decided NOT to Pursue Multi-Platform
*Reason*: macOS integration is a core value, would dilute focus

* Quick Wins You Can Do Right Now

#+begin_src bash
# 1. Count commented code
grep -c "^;; (" ~/emacs/emacs-settings/*.el | grep -v ":0$"

# 2. Find files missing lexical-binding
for f in ~/emacs/emacs-settings/*.el; do
  grep -q "lexical-binding: t" "$f" || echo "$f"
done

# 3. Profile current startup time
emacs --eval '(message "Startup time: %s" (emacs-init-time))' --kill
#+end_src

* Monthly Review Checklist

- [ ] Are high-priority items progressing?
- [ ] Any new critical issues to add?
- [ ] Can anything move from active → planned → done?
- [ ] Are stretch goals still relevant?

* Related Documentation

- =work-log.org= - History of what's been done
- =codebase-wisdom.org= - Lessons from bugs
- =design-architecture.org= - Current architecture
- =the-emacs-settings-approach.org= - Philosophy and principles
