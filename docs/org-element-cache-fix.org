#+TITLE: Org-Element Cache Fix Notes
#+AUTHOR: Jay Dixit
#+DATE: [2025-10-02 Thu]

* Problem Overview
- Repeated `org-element--cache` warnings and occasional parser errors (`Invalid search bound (wrong side of point)`) were triggered by custom editing helpers that modified Org buffers in multiple steps.
- Cached element positions drifted out of sync when functions mixed structural edits with cache queries or spanned multiple change notifications.

* Root Cause Summary
1. Inline editing commands (space/backspace/return) performed several insertions, deletions, and spacing fixes individually, so the cache attempted to re-parse a half-updated buffer.
2. Pasteboard helpers inserted text, then immediately re-scanned and rewrote the same region, forcing cache resync while the buffer kept changing.
3. Dropbox-synchronised org-roam files were sometimes updated outside Emacs, leaving cached positions stale until the buffer was reopened manually.

* Implemented Changes (2025-10-02)
- `smart-return.el`
  - `smart-return--insert-checklist-item` now wraps newline insertion in `combine-after-change-calls` + `atomic-change-group`.
  - `smart-return` caches all context first, batches each mutation, and uses `(org-return t)` when re-inserting region content.
- `spacecraft-mode.org`
  - `smart-space` and `my/delete-backward-and-capitalize` batch their edits via `combine-after-change-calls` and `atomic-change-group`, preventing piecemeal cache updates.
- `pasteboard-copy-and-paste-functions.org`
  - Added helper utilities (`pasteboard--clipboard-string`, `pasteboard--clean-string`, `pasteboard--demote-headings-in-string`, `convert-markdown-links-to-org-mode`).
- `pasteboard-paste-adaptive`, `pasteboard-paste-clean`, and `pasteboard-paste-verbatim` pre-process clipboard text in temp buffers before inserting it once.
- `shared-functions.org`
  - Added a `focus-in-hook` handler that runs `org-element-cache-reset 'force` for Dropbox-backed org-roam buffers after external syncs.

* Key Patterns to Remember
- **Read First, Write Later**: Capture cursor context (list state, headings, regions) before modifying the buffer.
- **Batch Mutations**: Wrap all edits in `combine-after-change-calls` (and `atomic-change-group` when multiple primitives are involved) so the cache re-syncs exactly once.
- **Pre-process Off-buffer**: Use temp buffers to clean or transform pasted text before a single insertion.
- **Reset on External Changes**: Force cache resets when files are updated outside the current Emacs session.

* Outstanding Considerations
- `shared-functions.el` loads several optional packages (`vertico`, `projectile`, `ox-twbs`). Ensure those dependencies are available when running the new focus-in hook in isolation.
- Continue to monitor org-element warnings; any new helper that edits Org structure should follow the same batching pattern.
