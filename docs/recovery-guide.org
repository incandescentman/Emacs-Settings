#+TITLE: Emacs Recovery Guide
#+DATE: 2025-12-31
#+DESCRIPTION: What to do when Emacs won't start

* When to Use This Guide

You launched Emacs and one of these happened:
- It crashed immediately
- It hung on startup (spinning forever)
- It opened but showed errors
- It opened but something is badly broken

This guide walks you through diagnosing and fixing the problem, from simple to nuclear.

* Step 1: See the Error

Open Terminal and run:

#+begin_src sh
emacs-debug
#+end_src

This launches Emacs with the debugger enabled. When it hits an error, you'll see a =*Backtrace*= buffer showing:
- Which file failed (e.g., =shared-functions.el=)
- Which function crashed (e.g., =void-function xyz=)
- The call stack leading to the error

*If Emacs hangs instead of erroring*: Press =C-g= repeatedly to interrupt, then check the =*Backtrace*= buffer.

*If you can't even get that far*: Skip to Step 4 (bypass Spacemacs entirely).

* Quick Reference

| Step | When                             | Action                          |
|------+----------------------------------+---------------------------------|
|    1 | Start here                       | =emacs-debug=                   |
|    2 | Error is in your config files    | Temporarily rename config       |
|    3 | "package not found" / corruption | =rm -rf ~/.emacs.d/elpa=        |
|    4 | Spacemacs itself is broken       | =emacs-vanilla= or =emacs-min=  |
|    5 | Nothing else works               | Re-clone Spacemacs              |

* Shell Aliases

These are defined in =jay-scripts.sh=:

#+begin_src sh
# Standard GUI launchers
alias Emacs="open -a /Applications/Emacs.app/Contents/MacOS/Emacs"
alias em="open -a /Applications/Emacs.app/Contents/MacOS/Emacs"

# Recovery launchers (use explicit path so flags work)
alias emacs-debug='/Applications/Emacs.app/Contents/MacOS/Emacs --debug-init'
alias emacs-vanilla='/Applications/Emacs.app/Contents/MacOS/Emacs -Q'
alias emacs-check='ls -ld ~/.emacs.d ~/.spacemacs ~/.spacemacs.d ~/starship'
alias emacs-known-good='SPACEMACSDIR=/Users/jay/emacs/emacs-settings-known-good/spacemacs.d /Applications/Emacs.app/Contents/MacOS/Emacs'
alias emacs-min='/Applications/Emacs.app/Contents/MacOS/Emacs -Q -l /Users/jay/emacs/emacs-settings/minimal-init.el'
#+end_src

*Why these use explicit paths*: Your =em= alias uses =open -a= which can't pass flags like =--debug-init=. These aliases invoke the Emacs.app binary directly.

* Your Setup (Reference)

#+begin_example
~/.emacs.d      → ~/emacs/spacemacs                        (Spacemacs core)
~/.spacemacs    → ~/starship/init.el                       (config entrypoint)
~/.spacemacs.d  → ~/emacs/emacs-settings/spacemacs.d       (config directory)
~/starship      → ~/emacs/emacs-settings/spacemacs.d       (convenience alias)
~/.emacs.d/elpa/                                           (packages)
#+end_example

*Canonical config file*: =~/emacs/emacs-settings/spacemacs.d/init.el=

*Verify symlinks are healthy*:
#+begin_src sh
ls -ld ~/.emacs.d ~/.spacemacs ~/.spacemacs.d ~/starship
#+end_src

* Step 2: Bypass Your Config

*Try this if*: the debug launch showed an error in one of your config files (e.g., =init.el=, =shared-functions.el=).

#+begin_src sh
# Temporarily move your config out of the way
mv ~/.spacemacs ~/.spacemacs.bak
mv ~/.spacemacs.d ~/.spacemacs.d.bak

# Launch Emacs - it will use vanilla Spacemacs defaults
open -a /Applications/Emacs.app
#+end_src

If Emacs works now, the problem is in your config. Restore and debug:

#+begin_src sh
mv ~/.spacemacs.bak ~/.spacemacs
mv ~/.spacemacs.d.bak ~/.spacemacs.d
#+end_src

* Step 3: Nuke Packages

*Try this if*: You see errors like "package not found", "wrong number of arguments", or package corruption after a Homebrew/Emacs upgrade.

#+begin_src sh
rm -rf ~/.emacs.d/elpa
open -a /Applications/Emacs.app
#+end_src

Spacemacs will re-download all ~500 packages. Takes 5-10 minutes.

* Step 4: Bypass Spacemacs Entirely

*Try this if*: Spacemacs itself seems broken, or you just need a working Emacs right now.

#+begin_src sh
emacs-vanilla  # Emacs with zero config
emacs-min      # Emacs with minimal-init.el
#+end_src

=emacs-vanilla= is useful for:
- Verifying Emacs itself works
- Emergency file editing
- Ruling out all config/Spacemacs issues

* Step 5: Nuclear - Fresh Spacemacs

*Try this if*: Nothing else worked. Spacemacs core itself is corrupted.

#+begin_src sh
cd ~/emacs
mv spacemacs spacemacs.broken
git clone https://github.com/syl20bnr/spacemacs ~/emacs/spacemacs
open -a /Applications/Emacs.app
#+end_src

Your config (in =emacs-settings/spacemacs.d=) is untouched. Only Spacemacs core is replaced.

* Appendix: Batch Syntax Check

If you edited a config file and want to check for syntax errors without launching the full GUI:

#+begin_src sh
# Check for unbalanced parentheses
/Applications/Emacs.app/Contents/MacOS/Emacs --batch ~/emacs/emacs-settings/spacemacs.d/init.el --eval '(check-parens)'

# Try to load a file (shows first 20 lines of output)
/Applications/Emacs.app/Contents/MacOS/Emacs --batch -l ~/emacs/emacs-settings/shared-functions.el 2>&1 | head -20
#+end_src

These run headless (no window) so they're fast.

* Appendix: Common Error Patterns

| Error Message                          | Likely Cause             | Try                   |
|----------------------------------------+--------------------------+-----------------------|
| "Symbol's function definition is void" | Missing package          | Step 3 (nuke elpa)    |
| "Cannot open load file"                | Bad path or symlink      | =emacs-check=           |
| "Wrong number of arguments"            | Package version mismatch | Step 3 (nuke elpa)    |
| "Recursive load"                       | Circular dependency      | Check recent changes  |
| Hangs on startup                       | Infinite loop            | =emacs-debug=, then C-g |

* Appendix: Prevention Tips

Before making risky config changes:

#+begin_src sh
cd ~/emacs/emacs-settings
git stash                    # Save uncommitted changes
# ... make your changes ...
# If broken: git stash pop   # Restore
#+end_src

* Appendix: "Known Good" Fallback

If you have a known-good worktree set up, you can boot from it:

#+begin_src sh
emacs-known-good
#+end_src

Verified 2025-12-31: =emacs-known-good= launches the GUI with the known-good worktree.

** Setting Up the Known-Good Worktree

#+begin_src sh
cd ~/emacs/emacs-settings
git tag -f known-good HEAD
git worktree add ~/emacs/emacs-settings-known-good known-good
#+end_src

** Updating After Successful Changes

#+begin_src sh
cd ~/emacs/emacs-settings
git tag -f known-good HEAD
cd ~/emacs/emacs-settings-known-good && git checkout known-good
#+end_src

* File Locations

| What           | Path                                           |
|----------------+------------------------------------------------|
| Spacemacs core | =~/emacs/spacemacs=                              |
| Your config    | =~/emacs/emacs-settings/spacemacs.d/init.el=     |
| Packages       | =~/.emacs.d/elpa/=                               |
| Backups        | =~/emacs/backup/per-save/=                       |
| This guide     | =~/emacs/emacs-settings/docs/recovery-guide.org= |

* Related Documentation

- =backup-system.org= - Full backup and recovery procedures
- =instructions.org= - General troubleshooting
- =codebase-wisdom.org= - Lessons from past debugging sessions
